---
name: Deploy to Neep Host

on:
  workflow_dispatch:
  issue_comment:
    types: [created]

env:
  TARGET_ARTIFACT_OS: ubuntu-24.04
  TARGET_ARTIFACT_BUILD: linux-release

jobs:
  deploy:
    if: |
      (
        github.event_name == 'workflow_dispatch'
      ) ||
      (
        github.event_name == 'issue_comment' &&
        github.event.issue.pull_request &&
        contains(github.event.comment.body, '/deploy') &&
        (
          github.event.comment.author_association == 'OWNER' ||
          github.event.comment.author_association == 'MEMBER' ||
          github.event.comment.author_association == 'COLLABORATOR'
        )
      )

    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      discussions: write
      actions: read

    steps:
      # ---------------------------------------------------------
      # Authenticate gh
      # ---------------------------------------------------------
      - name: Authenticate gh
        run: echo "${{ github.token }}" | gh auth login --with-token

      # ---------------------------------------------------------
      # React to command: üëÄ
      # ---------------------------------------------------------
      - name: React to comment (üëÄ)
        if: github.event_name == 'issue_comment'
        uses: peter-evans/create-or-update-comment@e8674b075228eee787fea43ef493e45ece1004c9
        with:
          token: ${{ github.token }}
          comment-id: ${{ github.event.comment.id }}
          reactions: eyes

      # ---------------------------------------------------------
      # Detect PR when running manually
      # ---------------------------------------------------------
      - name: Detect open PR for branch
        id: detect_pr
        if: github.event_name == 'workflow_dispatch'
        run: |
          BRANCH="${{ github.ref_name }}"
          PR_NUMBER="$(gh pr list --head "$BRANCH" --state open --json number --jq '.[0].number' || true)"

          {
            if [ -n "$PR_NUMBER" ]; then
              echo "pr_number=$PR_NUMBER"
              echo "has_pr=true"
            else
              echo "has_pr=false"
            fi
          } >> "$GITHUB_OUTPUT"

      # ---------------------------------------------------------
      # Extract PR branch from comment
      # ---------------------------------------------------------
      - uses: xt0rted/pull-request-comment-branch@e8b8daa837e8ea7331c0003c9c316a64c6d8b0b1
        if: github.event_name == 'issue_comment'
        id: comment-branch

      # ---------------------------------------------------------
      # Setup configs (branch, actor, PR number)
      # ---------------------------------------------------------
      - name: Setup configurations
        id: setup
        run: |
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            {
              echo "name=${{ steps.comment-branch.outputs.head_ref }}"
              echo "sha=${{ steps.comment-branch.outputs.head_sha }}"
              echo "actor=${{ github.event.comment.user.login }}"
              echo "pr_number=${{ github.event.issue.number }}"
              echo "has_pr=true"
            } >> "$GITHUB_OUTPUT"
          else
            {
              echo "name=${{ github.ref_name }}"
              echo "sha=${{ github.sha }}"
              echo "actor=${{ github.actor }}"
              echo "pr_number=${{ steps.detect_pr.outputs.pr_number }}"
              echo "has_pr=${{ steps.detect_pr.outputs.has_pr }}"
            } >> "$GITHUB_OUTPUT"
          fi

      # ---------------------------------------------------------
      # Checkout branch
      # ---------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.setup.outputs.name }}

      # ---------------------------------------------------------
      # Find the build run for the target branch
      # ---------------------------------------------------------
      - name: Find build run for SHA
        id: find_build
        run: |
          BRANCH="${{ steps.setup.outputs.name }}"
          SHA="${{ steps.setup.outputs.sha }}"

          echo "Searching for build of $SHA on branch $BRANCH"

          RUN_ID=$(gh run list \
            --workflow build-ubuntu.yml \
            --json databaseId,headSha,status \
            --jq "map(select(.headSha==\"$SHA\" and .status==\"completed\")) | first | .databaseId" \
            || true)

          if [ -z "$RUN_ID" ] || [ "$RUN_ID" = "null" ]; then
            echo "No successful build for SHA $SHA on branch $BRANCH"
            echo "found=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Found run $RUN_ID for correct SHA"
          {
            echo "found=true"
            echo "run_id=$RUN_ID"
          } >> "$GITHUB_OUTPUT"

      # ---------------------------------------------------------
      # Download artifact AND prepare deploy directory
      # ---------------------------------------------------------
      - name: Download and prepare deploy package
        id: artifact_prep
        if: steps.find_build.outputs.found == 'true'
        env:
          RUN_ID: ${{ steps.find_build.outputs.run_id }}
          SHA: ${{ steps.setup.outputs.sha }}
          OS: ${{ env.TARGET_ARTIFACT_OS }}
          BUILD: ${{ env.TARGET_ARTIFACT_BUILD }}
        run: |
          mkdir -p artifact-bin
          mkdir -p deploy

          echo "Downloading artifacts from run: $RUN_ID"
          gh run download "$RUN_ID" -D artifact-bin

          echo "Looking for folder: canary-${OS}-${BUILD}-${SHA}"
          ARTIFACT_DIR="artifact-bin/canary-${OS}-${BUILD}-${SHA}"

          if [ ! -d "$ARTIFACT_DIR" ]; then
            echo "Artifact directory not found: $ARTIFACT_DIR"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Copy binary
          cp "$ARTIFACT_DIR/canary" deploy/
          chmod +x deploy/canary

          echo "success=true" >> $GITHUB_OUTPUT

          echo "Deploy folder content:"
          ls -l deploy

      # ---------------------------------------------------------
      # Upload to server
      # ---------------------------------------------------------
      - name: Upload to server
        uses: appleboy/scp-action@ff85246acaad7bdce478db94a363cd2bf7c90345
        with:
          host: ${{ secrets.NEEP_HOST }}
          username: root
          password: ${{ secrets.NEEP_PASS }}
          source: "deploy/canary"
          target: "/opt/canary-next-deploy"

      # ---------------------------------------------------------
      # Remote deploy
      # ---------------------------------------------------------
      - name: Remote deploy
        id: remote
        uses: appleboy/ssh-action@91f3272fc5907f4699dcf59761eb622a07342f5a
        with:
          host: ${{ secrets.NEEP_HOST }}
          username: root
          password: ${{ secrets.NEEP_PASS }}
          timeout: 300s
          command_timeout: 20m
          script: |
            set +e
            trap '' TERM

            systemctl --no-ask-password --no-block stop canary || true

            cd /opt/canary
            git fetch origin
            git checkout "${{ steps.setup.outputs.name }}" || git checkout -b "${{ steps.setup.outputs.name }}"
            git reset --hard "origin/${{ steps.setup.outputs.name }}"

            if [ -f "/opt/canary-next-deploy/canary" ]; then
              mv /opt/canary-next-deploy/canary /opt/canary/canary
              chmod +x /opt/canary/canary
              echo "DEPLOYED_ARTIFACT=true"
            else
              echo "DEPLOYED_ARTIFACT=false"
            fi

            BRANCH="${{ steps.setup.outputs.name }}"
            ESCAPED_BRANCH="$(printf '%s\n' "$BRANCH" | sed 's/[\/&]/\\&/g')"
            sed -i "s/We are currently running [^.]*\./We are currently running $ESCAPED_BRANCH./" config.lua

            rm -rf /opt/canary-next-deploy
            systemctl start canary

      # ---------------------------------------------------------
      # Success or failure comment
      # ---------------------------------------------------------
      - name: Post deploy result
        if: steps.remote.outcome == 'success' && steps.setup.outputs.has_pr == 'true'
        uses: peter-evans/create-or-update-comment@e8674b075228eee787fea43ef493e45ece1004c9
        with:
          issue-number: ${{ steps.setup.outputs.pr_number }}
          body: |
            ‚úÖ **Deploy successful!**
            **Branch:** `${{ steps.setup.outputs.name }}`
            **Has new build artifact:** `${{ steps.find_build.outputs.found }}`
            **Build artifact prepared:** `${{ steps.artifact_prep.outputs.success || 'false' }}`
            **Binary deployed:** `${{ contains(steps.remote.outputs.stdout, 'DEPLOYED_ARTIFACT=true') }}`
            *(Triggered by @${{ steps.setup.outputs.actor }})*

      - name: Post failure feedback
        if: steps.remote.outcome != 'success' && steps.setup.outputs.has_pr == 'true'
        uses: peter-evans/create-or-update-comment@e8674b075228eee787fea43ef493e45ece1004c9
        with:
          issue-number: ${{ steps.setup.outputs.pr_number }}
          body: |
            ‚ùå **Deploy failed!**
            **Branch:** `${{ steps.setup.outputs.name }}`
            **Error output:**
            ```
            ${{ steps.remote.outputs.stderr }}
            ```
            *(Triggered by @${{ steps.setup.outputs.actor }})*

      # ---------------------------------------------------------
      # React with emojis
      # ---------------------------------------------------------
      - name: React success
        if: github.event_name == 'issue_comment' && steps.remote.outcome == 'success'
        uses: peter-evans/create-or-update-comment@e8674b075228eee787fea43ef493e45ece1004c9
        with:
          comment-id: ${{ github.event.comment.id }}
          reactions: hooray

      - name: React failure
        if: github.event_name == 'issue_comment' && steps.remote.outcome != 'success'
        uses: peter-evans/create-or-update-comment@e8674b075228eee787fea43ef493e45ece1004c9
        with:
          comment-id: ${{ github.event.comment.id }}
          reactions: "-1"
